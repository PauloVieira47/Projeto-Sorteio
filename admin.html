<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteio • Admin</title>
  <meta name="color-scheme" content="light dark">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #2B504A;
      --bg-soft:#21413C;
      --paper:#FFFFFF;
      --text:#0F1413;
      --muted:#6B7C79;
      --ring: rgba(43,80,74,.18);
      --primary:#2B504A;
      --primary-700:#21413C;
      --danger:#C9372C;
      --shadow: 0 8px 32px rgba(0,0,0,.25);
      --radius:14px;
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, var(--bg) 0%, #365F58 100%);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
    }
    .wrapper{ min-height:100svh; display:grid; grid-template-rows:auto 1fr; }
    header{
      padding: 18px 16px;
      display:flex;align-items:center;justify-content:space-between;
      color:#fff;
    }
    .brand{ display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.02em; }
    .brand .logo{
      width:36px;height:36px;border-radius:9px;
      background:#3C6E66;display:grid;place-items:center;font-size:14px;
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.12);
    }
    .logout{
      appearance:none;border:0;border-radius:10px;padding:10px 12px;
      color:#fff;background:rgba(255,255,255,.12);backdrop-filter: blur(6px);
      cursor:pointer;font-weight:700; display:none;
    }
    main{display:grid;place-items:center;padding: clamp(10px,3vw,24px)}
    .card{
      width:min(1024px, 96vw);
      background: var(--paper);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }
    .tabs{ display:grid;grid-auto-flow:column;gap:2px;background:#EFF4F3 }
    .tabs button{
      appearance:none;border:0;background:transparent;padding:14px 16px;
      font-weight:700;cursor:pointer;color:#3B4A48
    }
    .tabs button.active{background:#fff;color:#0F1413}
    .panel{padding:18px;display:none}
    .panel.active{display:block}

    /* Login view */
    .login{ display:grid;place-items:center;padding: clamp(24px,6vw,48px); }
    .login .box{
      width: min(420px, 92vw);
      background:#fff;border-radius:16px;box-shadow: var(--shadow);
      padding: 20px;
    }
    .title{margin:0 0 6px;font-size: clamp(20px, 4vw, 26px);font-weight:800}
    .subtitle{margin:0 0 14px;color:#5B6664;font-size:14px}
    .field{display:grid;gap:6px;margin-bottom:10px}
    .field label{font-weight:600;font-size:14px;color:#2B2F2E}
    .input{
      width:100%;padding:12px 14px;border:1px solid #E1E6E5;border-radius:12px;font-size:16px;
      outline: none;transition: box-shadow .2s, border-color .2s;
    }
    .input:focus{border-color:#C9D5D2; box-shadow:0 0 0 4px var(--ring)}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800;
      background: var(--primary);color:#fff;cursor:pointer;box-shadow:0 8px 24px rgba(43,80,74,.28)
    }
    .helper{font-size:12px;color:#6E7B79;margin-top:8px}

    /* Dashboard */
    .toolbar{ display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px }
    .metrics{display:flex;gap:8px;flex-wrap:wrap}
    .metric{
      background:#0E1514;color:#E8FFFB;border-radius:12px;padding:10px 12px;display:grid;gap:2px;min-width:120px
    }
    .metric small{opacity:.8}
    .search{ display:flex;gap:8px;align-items:center }
    .search .input{min-width:220px}
    table{width:100%;border-collapse: collapse;font-size:14px}
    thead th{background:#F6F8F7;text-align:left;padding:10px 8px;color:#4A5654;font-weight:700}
    tbody td{padding:10px 8px;border-top:1px solid #EEF1F0; word-break: break-word;}
    .btn-secondary{background:#0E1514;color:#E8FFFB}
    .btn-ghost{background: transparent; color: var(--primary); border:2px solid var(--primary)}
    .empty{ padding: 24px; text-align:center; color:#5E6C69 }

    /* Modal resultado */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);padding:16px}
    .modal .box{background:#fff;border-radius:16px;box-shadow:var(--shadow);width:min(520px,96vw);padding:18px}
    .winner{ background:#0E1514;color:#E8FFFB;border-radius:14px;padding:16px;display:grid;gap:4px;margin-top:8px }
    .winner .num{font-size: clamp(26px, 7vw, 40px);font-weight:900;letter-spacing:.08em}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:12px}
    .badge{ display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#EAF4F1;color:#2B504A;font-weight:800 }
    .hint{font-size:12px;color:#6E7B79}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">SC</div>
        <span>Admin do Sorteio</span>
      </div>
      <button class="logout" id="btnLogout">Sair</button>
    </header>

    <!-- LOGIN -->
    <section class="login" id="loginView">
      <div class="box">
        <h1 class="title">Acesse sua conta</h1>
        <p class="subtitle">Use o e-mail e senha definidos para o evento.</p>
        <div class="field">
          <label for="email">E-mail</label>
          <input id="email" class="input" type="email" placeholder="admin@demo.com" autocomplete="username">
        </div>
        <div class="field">
          <label for="password">Senha</label>
          <input id="password" class="input" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
        <button class="btn" id="btnLogin">Entrar</button>
        <div class="helper">Demo: <strong>admin@demo.com</strong> / <strong>123456</strong></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <main>
      <section class="card" id="dashView" style="display:none">
        <div class="tabs">
          <button class="active" data-tab="inscritos">Inscritos</button>
          <button data-tab="sorteio">Sorteio</button>
          <button data-tab="config">Configurações</button>
        </div>

        <!-- Inscritos -->
        <div class="panel active" id="panel-inscritos">
          <div class="toolbar">
            <div class="metrics">
              <div class="metric"><small>Total de inscritos</small><strong id="mTotal">0</strong></div>
              <div class="metric"><small>Último nº gerado</small><strong id="mLast">#0000</strong></div>
            </div>
            <div class="search">
              <input id="search" class="input" placeholder="Buscar por nome, e-mail ou telefone"/>
              <button class="btn btn-secondary" id="btnExport">Exportar CSV</button>
            </div>
          </div>

          <div id="empty" class="empty" style="display:none">Nenhum inscrito por enquanto.</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Nº</th><th>Nome</th><th>E-mail</th><th>Telefone</th><th>Data</th></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Sorteio -->
        <div class="panel" id="panel-sorteio">
          <div class="toolbar">
            <div class="metrics">
              <div class="metric"><small>Elegíveis</small><strong id="mElig">0</strong></div>
              <div class="metric"><small>Último sorteio</small><strong id="mDrawAt">—</strong></div>
            </div>
            <div class="row right">
              <button class="btn btn-ghost" id="btnTelao">Abrir Telão</button>
              <button class="btn" id="btnSortear">Sortear</button>
            </div>
          </div>
          <p class="hint">Dica: “Abrir Telão” abre <code>tela.html</code> em outra aba. Ao clicar “Sortear”, o telão recebe eventos via <code>BroadcastChannel</code>.</p>
          <div id="drawHistory"></div>
        </div>

        <!-- Config -->
        <div class="panel" id="panel-config">
          <p class="hint">Configurações (apenas visual, sem backend):</p>
          <div class="field" style="max-width:420px">
            <label for="slug">Slug do evento</label>
            <input id="slug" class="input" placeholder="ex.: palestra-xyz" />
          </div>
          <div class="field" style="max-width:420px">
            <label for="title">Título</label>
            <input id="title" class="input" placeholder="Título do evento" />
          </div>
          <button class="btn" id="btnSaveCfg">Salvar (demo)</button>
        </div>

      </section>
    </main>
  </div>

  <!-- Modal Resultado -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="badge" aria-hidden="true">✓</div>
      <h2 class="title">Vencedor sorteado</h2>
      <p class="subtitle">Resultado do sorteio atual</p>
      <div class="winner">
        <small>Número</small>
        <div class="num" id="wNum">#0000</div>
        <small>Nome</small>
        <strong id="wName">—</strong>
      </div>
      <div class="row">
        <button class="btn btn-ghost" id="btnFechar">Fechar</button>
        <button class="btn" id="btnRevelar">Revelar no Telão</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Estado (demo, sem backend)
    const EVENT_SLUG = 'default';
    const LS_PUB = 'sorteio:' + EVENT_SLUG;        // origem dos inscritos (a tela pública salva nesta chave)
    const LS_CFG = 'sorteio:cfg:' + EVENT_SLUG;    // configurações (demo)
    const LS_ADM = 'sorteio:admin:session';        // sessão fake

    const $ = (s)=>document.querySelector(s);
    const pad = (n, size=4)=> String(n).padStart(size, '0');
    const fmtDate = (d)=> new Date(d).toLocaleString('pt-BR');

    // carrega dados "públicos" (vêm do localStorage ou gera exemplos)
    function loadPub(){
      try{ return JSON.parse(localStorage.getItem(LS_PUB)) || { counter:0, people:{} }; }
      catch(e){ return { counter:0, people:{} }; }
    }
    function loadCfg(){
      try{ return JSON.parse(localStorage.getItem(LS_CFG)) || { slug: EVENT_SLUG, title: 'Sorteio do Evento' }; }
      catch(e){ return { slug: EVENT_SLUG, title: 'Sorteio do Evento' }; }
    }
    function saveCfg(v){ localStorage.setItem(LS_CFG, JSON.stringify(v)); }

    // materializa lista de inscritos
    function materializeParticipants(){
      const pub = loadPub();
      const now = Date.now();
      const arr = [];
      if(Object.keys(pub.people).length === 0){
        // exemplos para visual
        const sample = [
          ['Ana Paula', 'ana@demo.com', '(11) 9 1111-1111'],
          ['Bruno Silva', 'bruno@demo.com', '(11) 9 2222-2222'],
          ['Carla Souza', 'carla@demo.com', '(21) 9 3333-3333'],
          ['Diego Nunes', 'diego@demo.com', '(41) 9 4444-4444'],
          ['Eva Rocha', 'eva@demo.com', '(48) 9 5555-5555']
        ];
        sample.forEach((s,i)=>{
          arr.push({ ticket: i+1, name:s[0], email:s[1], phone:s[2], createdAt: now - (sample.length-i)*60000 });
        });
      }else{
        const people = pub.people;
        Object.keys(people).forEach((key,idx)=>{
          const [email, phone] = key.split('|');
          arr.push({ ticket: people[key], name: '—', email, phone, createdAt: now - (idx+1)*120000 });
        });
      }
      arr.sort((a,b)=> a.ticket - b.ticket);
      return arr;
    }

    // ===== Login fake
    const loginView = $('#loginView');
    const dashView  = $('#dashView');
    const btnLogout = $('#btnLogout');

    function isLogged(){
      try{ return JSON.parse(localStorage.getItem(LS_ADM))?.ok === true; }catch(e){ return false; }
    }
    function setLogged(ok){ localStorage.setItem(LS_ADM, JSON.stringify({ ok })); }
    function guard(){
      const ok = isLogged();
      loginView.style.display = ok ? 'none':'grid';
      dashView.style.display  = ok ? 'block':'none';
      btnLogout.style.display = ok ? 'inline-block':'none';
    }

    $('#btnLogin').addEventListener('click', ()=>{
      const email = $('#email').value.trim();
      const pass  = $('#password').value.trim();
      if(email === 'admin@demo.com' && pass === '123456'){
        setLogged(true); guard(); initDashboard();
      }else{
        alert('Credenciais inválidas (use admin@demo.com / 123456)');
      }
    });
    btnLogout.addEventListener('click', ()=>{ setLogged(false); guard(); });

    // ===== Tabs
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        $('#panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    // ===== Tabela de inscritos
    const tbody = $('#tbody');
    const mTotal = $('#mTotal');
    const mLast  = $('#mLast');
    const mElig  = $('#mElig');
    const search = $('#search');
    const empty  = $('#empty');

    let participants = [];

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
    function renderTable(filter=''){
      const txt = (filter||'').toLowerCase();
      const rows = participants.filter(p =>
         !txt
         || String(p.ticket).includes(txt)
         || (p.name||'').toLowerCase().includes(txt)
         || (p.email||'').toLowerCase().includes(txt)
         || (p.phone||'').toLowerCase().includes(txt)
      );
      tbody.innerHTML = rows.map(p=>`<tr>
        <td>#${String(p.ticket).padStart(4,'0')}</td>
        <td>${escapeHtml(p.name||'—')}</td>
        <td>${escapeHtml(p.email||'—')}</td>
        <td>${escapeHtml(p.phone||'—')}</td>
        <td>${fmtDate(p.createdAt)}</td>
      </tr>`).join('');
      empty.style.display = rows.length ? 'none':'block';
    }

    // Export CSV
    $('#btnExport').addEventListener('click', ()=>{
      const header = ['ticket','name','email','phone','createdAt'];
      const lines = [header.join(',')].concat(
        participants.map(p => [p.ticket, `"${(p.name||'').replace(/"/g,'""')}"`, p.email, p.phone, new Date(p.createdAt).toISOString()].join(','))
      );
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'inscritos.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ===== Sorteio (visual com BroadcastChannel)
    const btnSortear = $('#btnSortear');
    const btnTelao   = $('#btnTelao');
    const modal      = $('#modal');
    const wNum       = $('#wNum');
    const wName      = $('#wName');
    const btnFechar  = $('#btnFechar');
    const btnRevelar = $('#btnRevelar');
    const mDrawAt    = $('#mDrawAt');
    const drawHistory = $('#drawHistory');

    const channel = new BroadcastChannel('sorteio-channel'); // comunica com tela.html

    function pickWinner(list){
      if(!list.length) return null;
      const idx = crypto.getRandomValues(new Uint32Array(1))[0] % list.length;
      return list[idx];
    }
    function showModal(w){
      if(!w){ alert('Sem inscritos elegíveis.'); return; }
      wNum.textContent  = '#'+pad(w.ticket,4);
      wName.textContent = w.name || '—';
      modal.style.display = 'grid';
    }
    btnFechar.addEventListener('click', ()=> modal.style.display = 'none');
    btnRevelar.addEventListener('click', ()=>{
      channel.postMessage({ type:'DRAW_REVEAL', payload:{ number: wNum.textContent, name: wName.textContent } });
    });

    btnSortear.addEventListener('click', ()=>{
      const winner = pickWinner(participants);
      if(!winner){ alert('Nenhum inscrito para sortear.'); return; }
      const stamp = new Date();
      mDrawAt.textContent = stamp.toLocaleString('pt-BR');
      const item = document.createElement('div');
      item.className = 'hint';
      item.textContent = `${mDrawAt.textContent} → #${pad(winner.ticket,4)} — ${winner.name || '—'}`;
      drawHistory.prepend(item);

      channel.postMessage({ type:'DRAW_START' });
      setTimeout(()=>{
        channel.postMessage({ type:'DRAW_RESULT', payload:{ number: '#'+pad(winner.ticket,4), name: winner.name || '—' } });
        showModal(winner);
      }, 1600);
    });

    btnTelao.addEventListener('click', ()=>{ window.open('tela.html', '_blank'); });

    // ===== Config (demo)
    const inSlug = $('#slug');
    const inTitle = $('#title');
    $('#btnSaveCfg').addEventListener('click', ()=>{
      const cfg = { slug: inSlug.value.trim() || EVENT_SLUG, title: inTitle.value.trim() || 'Sorteio do Evento' };
      localStorage.setItem(LS_CFG, JSON.stringify(cfg));
      alert('Configurações salvas (demo).');
    });

    // ===== Bootstrap do Dashboard
    function initDashboard(){
      const cfg = loadCfg();
      inSlug.value = cfg.slug || EVENT_SLUG;
      inTitle.value = cfg.title || 'Sorteio do Evento';

      participants = materializeParticipants();
      mTotal.textContent = participants.length;
      const last = participants.length ? participants[participants.length-1].ticket : 0;
      mLast.textContent = '#'+pad(last,4);
      mElig.textContent = participants.length;

      renderTable('');
      search.addEventListener('input', (e)=> renderTable(e.target.value));
    }

    // start
    guard();
    if(isLogged()) initDashboard();
  </script>
</body>
</html>
